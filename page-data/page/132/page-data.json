{"componentChunkName":"component---src-templates-blog-list-tsx","path":"/page/132","result":{"data":{"allPost":{"edges":[{"node":{"ID":1832,"Title":"Launching a new Chromium-based WebView for Android","Description":"<p>Our in-app browser for Facebook on Android has historically relied on an Android System WebView based on Chromium, the open source project that powers many browsers on Android and other operating systems. On other mobile operating systems, the System WebView component cannot be updated without updating the entire operating system. On Android, this works differently, [...]</p>\n<p><a class=\"btn btn-secondary understrap-read-more-link\" href=\"https://engineering.fb.com/2022/09/30/android/launching-a-new-chromium-based-webview-for-android/\">Read More...</a></p>\n<p>The post <a rel=\"nofollow\" href=\"https://engineering.fb.com/2022/09/30/android/launching-a-new-chromium-based-webview-for-android/\">Launching a new Chromium-based WebView for Android</a> appeared first on <a rel=\"nofollow\" href=\"https://engineering.fb.com\">Engineering at Meta</a>.</p>\n","PublishedAt":"2022-09-30 17:00:40+00:00","OriginURL":"https://engineering.fb.com/2022/09/30/android/launching-a-new-chromium-based-webview-for-android/","SourceName":"Facebook"}},{"node":{"ID":1830,"Title":"Amazon File Cache – A High Performance Cache On AWS For Your On-Premises File Systems","Description":"I am pleased to announce today the availability of Amazon File Cache, a new high-speed cache service on AWS designed for processing file data stored in disparate locations—including on premises. File Cache accelerates and simplifies your most demanding cloud bursting and hybrid workflows by giving your applications access to files using a fast and familiar […]","PublishedAt":"2022-09-30 14:56:40+00:00","OriginURL":"https://aws.amazon.com/blogs/aws/amazon-file-cache-a-high-performance-cache-on-aws-for-your-on-premises-file-systems/","SourceName":"AWS"}},{"node":{"ID":1821,"Title":"Don't roll your own high cardinality analytics, use Workers Analytics Engine","Description":"Join our open beta and start collecting telemetry about anything using Cloudflare Workers today!","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/analytics-engine-open-beta/","SourceName":"Cloudflare"}},{"node":{"ID":1822,"Title":"Project A11Y: how we upgraded Cloudflare’s dashboard to adhere to industry accessibility standards","Description":"At Cloudflare, we believe the Internet should be accessible to everyone. And today, we’re happy to announce a more inclusive Cloudflare dashboard experience: adherence to the industry accessibility standards, including WCAG 2.1 AA and section 508 compliance.","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/project-a11y/","SourceName":"Cloudflare"}},{"node":{"ID":1823,"Title":"Lights, Camera, Action! Business and Pro customers get bundled streaming video","Description":"If you have a Business or Pro subscription, soon you will receive a free allocation of Cloudflare Stream.","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/stream-for-pro-biz-customers/","SourceName":"Cloudflare"}},{"node":{"ID":1824,"Title":"The home page for Internet insights: Cloudflare Radar 2.0","Description":"Cloudflare Radar makes Internet trends, patterns and insights available to everyone, and we’re now making them even easier to find, understand and share.","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/radar2/","SourceName":"Cloudflare"}},{"node":{"ID":1825,"Title":"The status page the Internet needs: Cloudflare Radar Outage Center","Description":"The new Cloudflare Radar Outage Center (CROC), launched as part of Radar 2.0, is intended to be an archive of information about Internet outages observed by Cloudflare","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/announcing-cloudflare-radar-outage-center/","SourceName":"Cloudflare"}},{"node":{"ID":1826,"Title":"Goodbye, Alexa. Hello, Cloudflare Radar Domain Rankings","Description":"Today, we are launching a new dataset called Radar Rankings, where we identify the top most popular domains that reflect how people use the Internet globally and per country.","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/radar-domain-rankings/","SourceName":"Cloudflare"}},{"node":{"ID":1827,"Title":"Gateway + CASB: alphabetti spaghetti that spells better SaaS security","Description":"Now that Cloudflare CASB is Generally Available, let’s take a look at how users have been leveraging other Cloudflare Zero Trust products with CASB, starting with Gateway","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/gateway-casb-in-action/","SourceName":"Cloudflare"}},{"node":{"ID":1829,"Title":"The Overflow #145: An entrepreneur embraces OSS","Description":"<p>Five nines without burnout, dealing with deference, and upcycling.</p>\n<p>The post <a rel=\"nofollow\" href=\"https://stackoverflow.blog/2022/09/30/the-overflow-145-an-entrepreneur-embraces-oss/\">The Overflow #145: An entrepreneur embraces OSS</a> appeared first on <a rel=\"nofollow\" href=\"https://stackoverflow.blog\">Stack Overflow Blog</a>.</p>\n","PublishedAt":"2022-09-30 13:00:00+00:00","OriginURL":"https://stackoverflow.blog/2022/09/30/the-overflow-145-an-entrepreneur-embraces-oss/","SourceName":"Stack Overflow"}},{"node":{"ID":1828,"Title":"Data Governance and Strategy for the Global Enterprise","Description":"<p>While the word &#8220;data&#8221; has been common since the 1940s, managing data&#8217;s growth, current use, and regulation is a relatively new frontier.  Governments and enterprises are working hard today to figure out the structures and regulations needed around data collection and use. According to Gartner, by 2023 65% of the world&#8217;s population will have their [&#8230;]</p>\n<p>The post <a rel=\"nofollow\" href=\"https://blog.cloudera.com/data-governance-and-strategy-for-the-global-enterprise-2/\">Data Governance and Strategy for the Global Enterprise</a> appeared first on <a rel=\"nofollow\" href=\"https://blog.cloudera.com\">Cloudera Blog</a>.</p>\n","PublishedAt":"2022-09-30 11:48:22+00:00","OriginURL":"https://blog.cloudera.com/data-governance-and-strategy-for-the-global-enterprise-2/","SourceName":"Cloudera"}},{"node":{"ID":1820,"Title":"We finally return to IRL events and Cassidy becomes a CTO (Ep. 492)","Description":"<p>We recap Stack's first ever customer conference and Cassidy shares her plans for tackling her first Chief Officer role.</p>\n<p>The post <a rel=\"nofollow\" href=\"https://stackoverflow.blog/2022/09/30/we-finally-return-to-irl-events-and-cassidy-becomes-a-cto-ep-492/\">We finally return to IRL events and Cassidy becomes a CTO (Ep. 492)</a> appeared first on <a rel=\"nofollow\" href=\"https://stackoverflow.blog\">Stack Overflow Blog</a>.</p>\n","PublishedAt":"2022-09-30 04:40:00+00:00","OriginURL":"https://stackoverflow.blog/2022/09/30/we-finally-return-to-irl-events-and-cassidy-becomes-a-cto-ep-492/","SourceName":"Stack Overflow"}},{"node":{"ID":1831,"Title":"Monitor Azure Container Apps with Datadog","Description":"<img class=\"webfeedsFeaturedVisual rss\" src=\"https://imgix.datadoghq.com/img/blog/azure-container-apps/azure-container-apps-hero.png\" width=\"100%\"/>Azure Container Apps is a serverless platform that enables you to deploy containerized applications and microservices—regardless of their code or framework—without managing any underlying cloud infrastructure or orchestrators. By using serverless containers, Azure Container Apps can automatically scale based on HTTP requests or events supported by Kubernetes event-driven autoscaling (KEDA) in order to accommodate peak demand and meet your budgeting goals. The service also integrates with the Distributed Application Runtime (DAPR), giving you a comprehensive suite of tools for deploying your container apps.","PublishedAt":"2022-09-30 00:00:00+00:00","OriginURL":"https://www.datadoghq.com/blog/azure-container-apps/","SourceName":"Datadog"}},{"node":{"ID":1835,"Title":"Run Datadog Synthetic tests in Azure Pipelines","Description":"<img class=\"webfeedsFeaturedVisual rss\" src=\"https://imgix.datadoghq.com/img/blog/azure-pipeline-testing-with-datadog-synthetic-monitoring/synthetics-azure-devops-extension-hero.png\" width=\"100%\"/>Continuous integration (CI) demands continous testing: shifting left helps prevent faulty code from spreading, which is one of the core aims of CI. Datadog’s new Azure DevOps extension enables you to seamlessly incorporate integration and end-to-end tests into existing CI/CD workflows on Azure Pipelines, a dedicated CI/CD service that automatically runs builds, performs tests, and deploys your services and applications via cloud-hosted pipelines. By incorporating these tests using Datadog Synthetic Monitoring, you can bolster your shift-left strategy and proactively assess user experience at each step of your development process.","PublishedAt":"2022-09-30 00:00:00+00:00","OriginURL":"https://www.datadoghq.com/blog/azure-pipeline-testing-with-datadog-synthetic-monitoring/","SourceName":"Datadog"}},{"node":{"ID":1851,"Title":"Datadog Support Terms","Description":"GENERAL Standard Support, or if purchased Premier Support, will be provided to Authorized Users in accordance with the terms of this document. Capitalized terms not otherwise defined in this document will have the respective meanings assigned to them in the applicable Master Subscription Agreement between Datadog and Customer.Requests for Support may be made through any of the channels referenced in the section below titled “Support Requests.” Customer agrees to provide Datadog with reasonable information and assistance to facilitate Datadog’s performance of Support, including, without limitation, a clear description of the issue, related configuration and log files, and cooperation to reproduce errors.","PublishedAt":"2022-09-30 00:00:00+00:00","OriginURL":"https://www.datadoghq.com/legal/support/2022-09-30/","SourceName":"Datadog"}},{"node":{"ID":1819,"Title":"Choosing the best Node.js Docker image","Description":"Snyk's Liran Tal discusses strategies for choosing the best node.js Docker image.","PublishedAt":"2022-09-29 22:38:21+00:00","OriginURL":"https://snyk.io/blog/choosing-the-best-node-js-docker-image/","SourceName":"Snyk"}},{"node":{"ID":1816,"Title":"Amazon WorkSpaces Introduces Ubuntu Desktops","Description":"At AWS, we love to give our customers choices: the choice of infrastructure to deploy your workloads, to store your most important data, or the operating systems for your virtual desktops. Many of you choose Amazon Workspaces to provision and distribute virtual desktops securely and at scale to your workforce. Our customers choose Workspaces when […]","PublishedAt":"2022-09-29 16:48:05+00:00","OriginURL":"https://aws.amazon.com/blogs/aws/amazon-workspaces-introduces-ubuntu-desktops/","SourceName":"AWS"}},{"node":{"ID":1815,"Title":"Dungeons & Dragons for Team Building","Description":"The HashiCorp Community team used a custom Dungeons & Dragons campaign as a team building exercise. Check out the highlights and then try it yourself.","PublishedAt":"2022-09-29 16:00:00+00:00","OriginURL":"https://www.hashicorp.com/blog/dungeons-dragons-for-team-building","SourceName":"HashiCorp"}},{"node":{"ID":1814,"Title":"A Day in the Life of a Cloud Engineer at Slack Australia","Description":"<p>06:15 AM My two young kids come in waking me up, presenting me with iPads in the hopes of a quick game of Minecraft before school. I sometimes give in as it might mean a few more minutes sleep! 07:00 AM It’s time for the first of many oat flat whites — or oat flatties [&#8230;]</p>\n<p>The post <a rel=\"nofollow\" href=\"https://slack.engineering/a-day-in-the-life-of-a-cloud-engineer-at-slack-australia/\">A Day in the Life of a Cloud Engineer at Slack Australia</a> appeared first on <a rel=\"nofollow\" href=\"https://slack.engineering\">Slack Engineering</a>.</p>\n","PublishedAt":"2022-09-29 15:36:47+00:00","OriginURL":"https://slack.engineering/a-day-in-the-life-of-a-cloud-engineer-at-slack-australia/","SourceName":"Slack"}},{"node":{"ID":1813,"Title":"Boost Productivity and Reset Your Day with a Brain Dump","Description":"<p>Pop quiz: How many things are on your mind right now? There may be deadlines looming at work, groceries to buy, or birthdays coming up. There’s a new show everyone’s talking about, ominous news reports, and that thing your boss asked you to follow up on. Yikes. Bits and bobs of thoughts swirl through our brains all day, and if we’re not careful, they can keep us up at night,</p>\n<p><a class=\"continue-reading\" href=\"https://evernote.com/blog/boost-productivity-and-reset-your-day-with-a-brain-dump/\">Continue reading...</a></p>\n<p>The post <a rel=\"nofollow\" href=\"https://evernote.com/blog/boost-productivity-and-reset-your-day-with-a-brain-dump/\">Boost Productivity and Reset Your Day with a Brain Dump</a> appeared first on <a rel=\"nofollow\" href=\"https://evernote.com/blog\"></a>.</p>\n","PublishedAt":"2022-09-29 13:30:00+00:00","OriginURL":"https://evernote.com/blog/boost-productivity-and-reset-your-day-with-a-brain-dump/","SourceName":"Evernote"}},{"node":{"ID":1806,"Title":"Click Here! (safely): Automagical Browser Isolation for potentially unsafe links in email","Description":"There’s always a cat and mouse game between hackers and security companies. New attacks try to weaponize website links after emails have been delivered to mailboxes, and Email Link Isolation is here to revolutionize protection against those attacks.","PublishedAt":"2022-09-29 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/safe-email-links/","SourceName":"Cloudflare"}},{"node":{"ID":1807,"Title":"Back in 2017 we gave you Unmetered DDoS Mitigation, here's a birthday gift: Unmetered Rate Limiting","Description":"Starting today, Free, Pro and Business plans include Rate Limiting rules without additional charges.","PublishedAt":"2022-09-29 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/unmetered-ratelimiting/","SourceName":"Cloudflare"}},{"node":{"ID":1808,"Title":"Now all customers can share access to their Cloudflare account with Role Based Access Controls","Description":"Role Based Access Controls are now available for every plan!","PublishedAt":"2022-09-29 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/rbac-for-everyone/","SourceName":"Cloudflare"}},{"node":{"ID":1809,"Title":"How Cloudflare implemented hardware keys with FIDO2 and Zero Trust to prevent phishing","Description":"Adopting a phishing resistant second factor, like a YubiKey with FIDO2, is the number one way to prevent phishing attacks. Cloudflare has used phishing resistant second factors only since February 2021, and these were the steps we took to accomplish that.","PublishedAt":"2022-09-29 13:00:00+00:00","OriginURL":"https://blog.cloudflare.com/how-cloudflare-implemented-fido2-and-zero-trust/","SourceName":"Cloudflare"}},{"node":{"ID":1810,"Title":"The (hardware) key to making phishing defense seamless with Cloudflare Zero Trust and Yubico","Description":"Announcing a new collaboration with Yubico, to remove any barriers for organizations of any size to deploying hardware security keys.","PublishedAt":"2022-09-29 12:58:00+00:00","OriginURL":"https://blog.cloudflare.com/making-phishing-defense-seamless-cloudflare-yubico/","SourceName":"Cloudflare"}},{"node":{"ID":1804,"Title":"Announcing GA of DataFlow Functions","Description":"<p>Technology Spotlight</p>\n<p>The post <a rel=\"nofollow\" href=\"https://blog.cloudera.com/announcing-ga-of-dataflow-functions/\">Announcing GA of DataFlow Functions</a> appeared first on <a rel=\"nofollow\" href=\"https://blog.cloudera.com\">Cloudera Blog</a>.</p>\n","PublishedAt":"2022-09-29 10:00:48+00:00","OriginURL":"https://blog.cloudera.com/announcing-ga-of-dataflow-functions/","SourceName":"Cloudera"}},{"node":{"ID":1805,"Title":"Serverless NiFi Flows with DataFlow Functions: The Next Step in the DataFlow Service Evolution","Description":"<p>Cloudera DataFlow for the Public Cloud (CDF-PC) is a cloud-native service for Apache NiFi within the Cloudera Data Platform (CDP). CDF-PC enables organizations to take control of their data flows and eliminate ingestion silos by allowing developers to connect to any data source anywhere with any structure, process it, and deliver to any destination using [&#8230;]</p>\n<p>The post <a rel=\"nofollow\" href=\"https://blog.cloudera.com/serverless-nifi-flows-with-dataflow-functions-the-next-step-in-the-dataflow-service-evolution/\">Serverless NiFi Flows with DataFlow Functions: The Next Step in the DataFlow Service Evolution</a> appeared first on <a rel=\"nofollow\" href=\"https://blog.cloudera.com\">Cloudera Blog</a>.</p>\n","PublishedAt":"2022-09-29 10:00:47+00:00","OriginURL":"https://blog.cloudera.com/serverless-nifi-flows-with-dataflow-functions-the-next-step-in-the-dataflow-service-evolution/","SourceName":"Cloudera"}},{"node":{"ID":1811,"Title":"Spotlight on support: Elastic's support team treats one another—and its customers—like humans","Description":"","PublishedAt":"2022-09-29 00:00:00+00:00","OriginURL":"https://www.elastic.co/blog/culture-spotlight-on-support","SourceName":"Elastic"}},{"node":{"ID":1812,"Title":"Blog: Enforce CRD Immutability with CEL Transition Rules","Description":"<p><strong>Author:</strong> <a href=\"https://github.com/alexzielenski\">Alexander Zielenski</a> (Google)</p>\n<p>Immutable fields can be found in a few places in the built-in Kubernetes types.\nFor example, you can't change the <code>.metadata.name</code> of an object. Specific objects\nhave fields where changes to existing objects are constrained; for example, the\n<code>.spec.selector</code> of a Deployment.</p>\n<p>Aside from simple immutability, there are other common design patterns such as\nlists which are append-only, or a map with mutable values and immutable keys.</p>\n<p>Until recently the best way to restrict field mutability for CustomResourceDefinitions\nhas been to create a validating\n<a href=\"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks\">admission webhook</a>:\nthis means a lot of complexity for the common case of making a field immutable.</p>\n<p>Beta since Kubernetes 1.25, CEL Validation Rules allow CRD authors to express\nvalidation constraints on their fields using a rich expression language,\n<a href=\"https://github.com/google/cel-spec\">CEL</a>. This article explores how you can\nuse validation rules to implement a few common immutability patterns directly in\nthe manifest for a CRD.</p>\n<h2 id=\"basics-of-validation-rules\">Basics of validation rules</h2>\n<p>The new support for CEL validation rules in Kubernetes allows CRD authors to add\ncomplicated admission logic for their resources without writing any code!</p>\n<p>For example, A CEL rule to constrain a field <code>maximumSize</code> to be greater than a\n<code>minimumSize</code> for a CRD might look like the following:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-yaml\" data-lang=\"yaml\"><span style=\"display:flex;\"><span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span>|<span style=\"color:#b44;font-style:italic\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44;font-style:italic\"> </span><span style=\"color:#bbb\"> </span>self.maximumSize &gt; self.minimumSize<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"></span><span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#b44\">&#39;Maximum size must be greater than minimum size.&#39;</span><span style=\"color:#bbb\">\n</span></span></span></code></pre></div><p>The rule field contains an expression written in CEL. <code>self</code> is a special keyword\nin CEL which refers to the object whose type contains the rule.</p>\n<p>The message field is an error message which will be sent to Kubernetes clients\nwhenever this particular rule is not satisfied.</p>\n<p>For more details about the capabilities and limitations of Validation Rules using\nCEL, please refer to\n<a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation-rules\">validation rules</a>.\nThe <a href=\"https://github.com/google/cel-spec\">CEL specification</a> is also a good\nreference for information specifically related to the language.</p>\n<h2 id=\"immutability-patterns-with-cel-validation-rules\">Immutability patterns with CEL validation rules</h2>\n<p>This section implements several common use cases for immutability in Kubernetes\nCustomResourceDefinitions, using validation rules expressed as\n<a href=\"https://book.kubebuilder.io/reference/markers/crd.html\">kubebuilder marker comments</a>.\nResultant OpenAPI generated by the kubebuilder marker comments will also be\nincluded so that if you are writing your CRD manifests by hand you can still\nfollow along.</p>\n<h2 id=\"project-setup\">Project setup</h2>\n<p>To use CEL rules with kubebuilder comments, you first need to set up a Golang\nproject structure with the CRD defined in Go.</p>\n<p>You may skip this step if you are not using kubebuilder or are only interested\nin the resultant OpenAPI extensions.</p>\n<p>Begin with a folder structure of a Go module set up like the following. If\nyou have your own project already set up feel free to adapt this tutorial to your liking:</p>\n<figure>\n<div class=\"mermaid\">\ngraph LR\n. --> generate.go\n. --> pkg --> apis --> stable.example.com --> v1\nv1 --> doc.go\nv1 --> types.go\n. --> tools.go\n</div>\n</figure>\n<noscript>\n<div class=\"alert alert-secondary callout\" role=\"alert\">\n<em class=\"javascript-required\">JavaScript must be <a href=\"https://www.enable-javascript.com/\">enabled</a> to view this content</em>\n</div>\n</noscript>\n<p>This is the typical folder structure used by Kubernetes projects for defining new API resources.</p>\n<p><code>doc.go</code> contains package-level metadata such as the group and the version:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +groupName=stable.example.com\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +versionName=v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">package</span> v1\n</span></span></code></pre></div><p><code>types.go</code> contains all type definitions in stable.example.com/v1</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">package</span> v1\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">import</span> (\n</span></span><span style=\"display:flex;\"><span> metav1 <span style=\"color:#b44\">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>\n</span></span><span style=\"display:flex;\"><span>)\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// An empty CRD as an example of defining a type using controller tools\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +kubebuilder:storageversion\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +kubebuilder:subresource:status\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">type</span> TestCRD <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> metav1.TypeMeta <span style=\"color:#b44\">`json:&#34;,inline&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> metav1.ObjectMeta <span style=\"color:#b44\">`json:&#34;metadata,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span> Spec TestCRDSpec <span style=\"color:#b44\">`json:&#34;spec,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> Status TestCRDStatus <span style=\"color:#b44\">`json:&#34;status,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>}\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">type</span> TestCRDStatus <span style=\"color:#a2f;font-weight:bold\">struct</span> {}\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">type</span> TestCRDSpec <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> <span style=\"color:#080;font-style:italic\">// You will fill this in as you go along\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span>}\n</span></span></code></pre></div><p><code>tools.go</code> contains a dependency on <a href=\"https://book.kubebuilder.io/reference/generating-crd.html#generating-crds\">controller-gen</a> which will be used to generate the CRD definition:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">//go:build tools\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">package</span> celimmutabilitytutorial\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// Force direct dependency on code-generator so that it may be executed with go run\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">import</span> (\n</span></span><span style=\"display:flex;\"><span> _ <span style=\"color:#b44\">&#34;sigs.k8s.io/controller-tools/cmd/controller-gen&#34;</span>\n</span></span><span style=\"display:flex;\"><span>)\n</span></span></code></pre></div><p>Finally, <code>generate.go</code>contains a <code>go:generate</code> directive to make use of\n<code>controller-gen</code>. <code>controller-gen</code> parses our <code>types.go</code> and creates generates\nCRD yaml files into a <code>crd</code> folder:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">package</span> celimmutabilitytutorial\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">//go:generate go run sigs.k8s.io/controller-tools/cmd/controller-gen crd paths=./pkg/apis/... output:dir=./crds\n</span></span></span></code></pre></div><p>You may now want to add dependencies for our definitions and test the code generation:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span><span style=\"color:#a2f\">cd</span> cel-immutability-tutorial\n</span></span><span style=\"display:flex;\"><span>go mod init &lt;your-org&gt;/&lt;your-module-name&gt;\n</span></span><span style=\"display:flex;\"><span>go mod tidy\n</span></span><span style=\"display:flex;\"><span>go generate ./...\n</span></span></code></pre></div><p>After running these commands you now have completed the basic project structure.\nYour folder tree should look like the following:</p>\n<figure>\n<div class=\"mermaid\">\ngraph LR\n. --> crds --> stable.example.com_testcrds.yaml\n. --> generate.go\n. --> go.mod\n. --> go.sum\n. --> pkg --> apis --> stable.example.com --> v1\nv1 --> doc.go\nv1 --> types.go\n. --> tools.go\n</div>\n</figure>\n<noscript>\n<div class=\"alert alert-secondary callout\" role=\"alert\">\n<em class=\"javascript-required\">JavaScript must be <a href=\"https://www.enable-javascript.com/\">enabled</a> to view this content</em>\n</div>\n</noscript>\n<p>The manifest for the example CRD is now available in <code>crds/stable.example.com_testcrds.yaml</code>.</p>\n<h2 id=\"immutablility-after-first-modification\">Immutablility after first modification</h2>\n<p>A common immutability design pattern is to make the field immutable once it has\nbeen first set. This example will throw a validation error if the field after\nchanges after being first initialized.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;!has(oldSelf.value) || has(self.value)&#34;, message=&#34;Value is required once set&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">type</span> ImmutableSinceFirstWrite <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> metav1.TypeMeta <span style=\"color:#b44\">`json:&#34;,inline&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> metav1.ObjectMeta <span style=\"color:#b44\">`json:&#34;metadata,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:Optional\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;self == oldSelf&#34;,message=&#34;Value is immutable&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:MaxLength=512\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> Value <span style=\"color:#0b0;font-weight:bold\">string</span> <span style=\"color:#b44\">`json:&#34;value&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>}\n</span></span></code></pre></div><p>The <code>+kubebuilder</code> directives in the comments inform controller-gen how to\nannotate the generated OpenAPI. The <code>XValidation</code> rule causes the rule to appear\namong the <code>x-kubernetes-validations</code> OpenAPI extension. Kubernetes then\nrespects the OpenAPI spec to enforce our constraints.</p>\n<p>To enforce a field's immutability after its first write, you need to apply the following constraints:</p>\n<ol>\n<li>Field must be allowed to be initially unset <code>+kubebuilder:validation:Optional</code></li>\n<li>Once set, field must not be allowed to be removed: <code>!has(oldSelf.value) | has(self.value)</code> (type-scoped rule)</li>\n<li>Once set, field must not be allowed to change value <code>self == oldSelf</code> (field-scoped rule)</li>\n</ol>\n<p>Also note the additional directive <code>+kubebuilder:validation:MaxLength</code>. CEL\nrequires that all strings have attached max length so that it may estimate the\ncomputation cost of the rule. Rules that are too expensive will be rejected.\nFor more information on CEL cost budgeting, check out the other tutorial.</p>\n<h3 id=\"example-usage\">Example usage</h3>\n<p>Generating and installing the CRD should succeed:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"># Ensure the CRD yaml is generated by controller-gen</span>\n</span></span><span style=\"display:flex;\"><span>go generate ./...\n</span></span><span style=\"display:flex;\"><span>kubectl apply -f crds/stable.example.com_immutablesincefirstwrites.yaml\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">customresourcedefinition.apiextensions.k8s.io/immutablesincefirstwrites.stable.example.com created\n</span></span></span></code></pre></div><p>Creating initial empty object with no <code>value</code> is permitted since <code>value</code> is <code>optional</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceFirstWrite\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">immutablesincefirstwrite.stable.example.com/test1 created\n</span></span></span></code></pre></div><p>The initial modification of <code>value</code> succeeds:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceFirstWrite\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value: Hello, world!\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">immutablesincefirstwrite.stable.example.com/test1 configured\n</span></span></span></code></pre></div><p>An attempt to change <code>value</code> is blocked by the field-level validation rule. Note\nthe error message shown to the user comes from the validation rule.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceFirstWrite\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value: Hello, new world!\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The ImmutableSinceFirstWrite &#34;test1&#34; is invalid: value: Invalid value: &#34;string&#34;: Value is immutable\n</span></span></span></code></pre></div><p>An attempt to remove the <code>value</code> field altogether is blocked by the other validation rule\non the type. The error message also comes from the rule.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceFirstWrite\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The ImmutableSinceFirstWrite &#34;test1&#34; is invalid: &lt;nil&gt;: Invalid value: &#34;object&#34;: Value is required once set\n</span></span></span></code></pre></div><h3 id=\"generated-schema\">Generated schema</h3>\n<p>Note that in the generated schema there are two separate rule locations.\nOne is directly attached to the property <code>immutable_since_first_write</code>.\nThe other rule is associated with the crd type itself.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-yaml\" data-lang=\"yaml\"><span style=\"display:flex;\"><span><span style=\"color:#008000;font-weight:bold\">openAPIV3Schema</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">properties</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">value</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">maxLength</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#666\">512</span><span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>string<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Value is immutable<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span>self == oldSelf<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>object<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Value is required once set<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#b44\">&#39;!has(oldSelf.value) || has(self.value)&#39;</span><span style=\"color:#bbb\">\n</span></span></span></code></pre></div><h2 id=\"immutability-upon-object-creation\">Immutability upon object creation</h2>\n<p>A field which is immutable upon creation time is implemented similarly to the\nearlier example. The difference is that that field is marked required, and the\ntype-scoped rule is no longer necessary.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#a2f;font-weight:bold\">type</span> ImmutableSinceCreation <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> metav1.TypeMeta <span style=\"color:#b44\">`json:&#34;,inline&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> metav1.ObjectMeta <span style=\"color:#b44\">`json:&#34;metadata,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:Required\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;self == oldSelf&#34;,message=&#34;Value is immutable&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:MaxLength=512\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> Value <span style=\"color:#0b0;font-weight:bold\">string</span> <span style=\"color:#b44\">`json:&#34;value&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>}\n</span></span></code></pre></div><p>This field will be required when the object is created, and after that point will\nnot be allowed to be modified. Our CEL Validation Rule <code>self == oldSelf</code></p>\n<h3 id=\"usage-example\">Usage example</h3>\n<p>Generating and installing the CRD should succeed:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"># Ensure the CRD yaml is generated by controller-gen</span>\n</span></span><span style=\"display:flex;\"><span>go generate ./...\n</span></span><span style=\"display:flex;\"><span>kubectl apply -f crds/stable.example.com_immutablesincecreations.yaml\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">customresourcedefinition.apiextensions.k8s.io/immutablesincecreations.stable.example.com created\n</span></span></span></code></pre></div><p>Applying an object without the required field should fail:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceCreation\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The ImmutableSinceCreation &#34;test1&#34; is invalid:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#888\">* value: Required value\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#888\">* &lt;nil&gt;: Invalid value: &#34;null&#34;: some validation rules were not checked because the object was invalid; correct the existing errors to complete validation\n</span></span></span></code></pre></div><p>Now that the field has been added, the operation is permitted:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceCreation\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value: Hello, world!\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">immutablesincecreation.stable.example.com/test1 created\n</span></span></span></code></pre></div><p>If you attempt to change the <code>value</code>, the operation is blocked due to the\nvalidation rules in the CRD. Note that the error message is as it was defined\nin the validation rule.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceCreation\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value: Hello, new world!\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The ImmutableSinceCreation &#34;test1&#34; is invalid: value: Invalid value: &#34;string&#34;: Value is immutable\n</span></span></span></code></pre></div><p>Also if you attempted to remove <code>value</code> altogether after adding it, you will\nsee an error as expected:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: ImmutableSinceCreation\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: test1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The ImmutableSinceCreation &#34;test1&#34; is invalid:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#888\">* value: Required value\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#888\">* &lt;nil&gt;: Invalid value: &#34;null&#34;: some validation rules were not checked because the object was invalid; correct the existing errors to complete validation\n</span></span></span></code></pre></div><h3 id=\"generated-schema-1\">Generated schema</h3>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-yaml\" data-lang=\"yaml\"><span style=\"display:flex;\"><span><span style=\"color:#008000;font-weight:bold\">openAPIV3Schema</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">properties</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">value</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">maxLength</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#666\">512</span><span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>string<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Value is immutable<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span>self == oldSelf<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">required</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- value<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>object<span style=\"color:#bbb\">\n</span></span></span></code></pre></div><h2 id=\"append-only-list-of-containers\">Append-only list of containers</h2>\n<p>In the case of ephemeral containers on Pods, Kubernetes enforces that the\nelements in the list are immutable, and can’t be removed. The following example\nshows how you could use CEL to achieve the same behavior.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;!has(oldSelf.value) || has(self.value)&#34;, message=&#34;Value is required once set&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">type</span> AppendOnlyList <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> metav1.TypeMeta <span style=\"color:#b44\">`json:&#34;,inline&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> metav1.ObjectMeta <span style=\"color:#b44\">`json:&#34;metadata,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:Optional\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:MaxItems=100\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;oldSelf.all(x, x in self)&#34;,message=&#34;Values may only be added&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> Values []v1.EphemeralContainer <span style=\"color:#b44\">`json:&#34;value&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>}\n</span></span></code></pre></div><ol>\n<li>Once set, field must not be deleted: <code>!has(oldSelf.value) || has(self.value)</code> (type-scoped)</li>\n<li>Once a value is added it is not removed: <code>oldSelf.all(x, x in self)</code> (field-scoped)</li>\n<li>Value may be initially unset: <code>+kubebuilder:validation:Optional</code></li>\n</ol>\n<p>Note that for cost-budgeting purposes, <code>MaxItems</code> is also required to be specified.</p>\n<h3 id=\"example-usage-1\">Example usage</h3>\n<p>Generating and installing the CRD should succeed:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"># Ensure the CRD yaml is generated by controller-gen</span>\n</span></span><span style=\"display:flex;\"><span>go generate ./...\n</span></span><span style=\"display:flex;\"><span>kubectl apply -f crds/stable.example.com_appendonlylists.yaml\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">customresourcedefinition.apiextensions.k8s.io/appendonlylists.stable.example.com created\n</span></span></span></code></pre></div><p>Creating an inital list with one element inside should succeed without problem:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: AppendOnlyList\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testlist\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> - name: container1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> image: nginx/nginx\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">appendonlylist.stable.example.com/testlist created\n</span></span></span></code></pre></div><p>Adding an element to the list should also proceed without issue as expected:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: AppendOnlyList\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testlist\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> - name: container1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> image: nginx/nginx\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> - name: container2\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> image: mongodb/mongodb\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">appendonlylist.stable.example.com/testlist configured\n</span></span></span></code></pre></div><p>But if you now attempt to remove an element, the error from the validation rule\nis triggered:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: AppendOnlyList\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testlist\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">value:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> - name: container1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> image: nginx/nginx\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The AppendOnlyList &#34;testlist&#34; is invalid: value: Invalid value: &#34;array&#34;: Values may only be added\n</span></span></span></code></pre></div><p>Additionally, to attempt to remove the field once it has been set is also disallowed\nby the type-scoped validation rule.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: AppendOnlyList\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testlist\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The AppendOnlyList &#34;testlist&#34; is invalid: &lt;nil&gt;: Invalid value: &#34;object&#34;: Value is required once set\n</span></span></span></code></pre></div><h3 id=\"generated-schema-2\">Generated schema</h3>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-yaml\" data-lang=\"yaml\"><span style=\"display:flex;\"><span><span style=\"color:#008000;font-weight:bold\">openAPIV3Schema</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">properties</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">value</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">items</span>:<span style=\"color:#bbb\"> </span>...<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">maxItems</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#666\">100</span><span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>array<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Values may only be added<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span>oldSelf.all(x, x in self)<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>object<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Value is required once set<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#b44\">&#39;!has(oldSelf.value) || has(self.value)&#39;</span><span style=\"color:#bbb\">\n</span></span></span></code></pre></div><h2 id=\"map-with-append-only-keys-immutable-values\">Map with append-only keys, immutable values</h2>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-go\" data-lang=\"go\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// A map which does not allow keys to be removed or their values changed once set. New keys may be added, however.\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;!has(oldSelf.values) || has(self.values)&#34;, message=&#34;Value is required once set&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span><span style=\"color:#a2f;font-weight:bold\">type</span> MapAppendOnlyKeys <span style=\"color:#a2f;font-weight:bold\">struct</span> {\n</span></span><span style=\"display:flex;\"><span> metav1.TypeMeta <span style=\"color:#b44\">`json:&#34;,inline&#34;`</span>\n</span></span><span style=\"display:flex;\"><span> metav1.ObjectMeta <span style=\"color:#b44\">`json:&#34;metadata,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>\n</span></span><span style=\"display:flex;\"><span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:Optional\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:MaxProperties=10\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> <span style=\"color:#080;font-style:italic\">// +kubebuilder:validation:XValidation:rule=&#34;oldSelf.all(key, key in self &amp;&amp; self[key] == oldSelf[key])&#34;,message=&#34;Keys may not be removed and their values must stay the same&#34;\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"></span> Values <span style=\"color:#a2f;font-weight:bold\">map</span>[<span style=\"color:#0b0;font-weight:bold\">string</span>]<span style=\"color:#0b0;font-weight:bold\">string</span> <span style=\"color:#b44\">`json:&#34;values,omitempty&#34;`</span>\n</span></span><span style=\"display:flex;\"><span>}\n</span></span></code></pre></div><ol>\n<li>Once set, field must not be deleted: <code>!has(oldSelf.values) || has(self.values)</code> (type-scoped)</li>\n<li>Once a key is added it is not removed nor is its value modified: <code>oldSelf.all(key, key in self &amp;&amp; self[key] == oldSelf[key])</code> (field-scoped)</li>\n<li>Value may be initially unset: <code>+kubebuilder:validation:Optional</code></li>\n</ol>\n<h3 id=\"example-usage-2\">Example usage</h3>\n<p>Generating and installing the CRD should succeed:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span><span style=\"color:#080;font-style:italic\"># Ensure the CRD yaml is generated by controller-gen</span>\n</span></span><span style=\"display:flex;\"><span>go generate ./...\n</span></span><span style=\"display:flex;\"><span>kubectl apply -f crds/stable.example.com_mapappendonlykeys.yaml\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">customresourcedefinition.apiextensions.k8s.io/mapappendonlykeys.stable.example.com created\n</span></span></span></code></pre></div><p>Creating an initial object with one key within <code>values</code> should be permitted:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: MapAppendOnlyKeys\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testmap\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">values:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> key1: value1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">mapappendonlykeys.stable.example.com/testmap created\n</span></span></span></code></pre></div><p>Adding new keys to the map should also be permitted:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: MapAppendOnlyKeys\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testmap\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">values:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> key1: value1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> key2: value2\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">mapappendonlykeys.stable.example.com/testmap configured\n</span></span></span></code></pre></div><p>But if a key is removed, the error messagr from the validation rule should be\nreturned:</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: MapAppendOnlyKeys\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testmap\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">values:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> key1: value1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The MapAppendOnlyKeys &#34;testmap&#34; is invalid: values: Invalid value: &#34;object&#34;: Keys may not be removed and their values must stay the same\n</span></span></span></code></pre></div><p>If the entire field is removed, the other validation rule is triggered and the\noperation is prevented. Note that the error message for the validation rule is\nshown to the user.</p>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-shell\" data-lang=\"shell\"><span style=\"display:flex;\"><span>kubectl apply -f - <span style=\"color:#b44\">&lt;&lt;EOF\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">---\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">apiVersion: stable.example.com/v1\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">kind: MapAppendOnlyKeys\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">metadata:\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\"> name: testmap\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#b44\">EOF</span>\n</span></span></code></pre></div><div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-console\" data-lang=\"console\"><span style=\"display:flex;\"><span><span style=\"color:#888\">The MapAppendOnlyKeys &#34;testmap&#34; is invalid: &lt;nil&gt;: Invalid value: &#34;object&#34;: Value is required once set\n</span></span></span></code></pre></div><h3 id=\"generated-schema-3\">Generated schema</h3>\n<div class=\"highlight\"><pre tabindex=\"0\" style=\"background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"><code class=\"language-yaml\" data-lang=\"yaml\"><span style=\"display:flex;\"><span><span style=\"color:#008000;font-weight:bold\">openAPIV3Schema</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">description</span>:<span style=\"color:#bbb\"> </span>A map which does not allow keys to be removed or their values<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>changed once set. New keys may be added, however.<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">properties</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">values</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">additionalProperties</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>string<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">maxProperties</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#666\">10</span><span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>object<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Keys may not be removed and their values must stay the same<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span>oldSelf.all(key, key in self &amp;&amp; self[key] == oldSelf[key])<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">type</span>:<span style=\"color:#bbb\"> </span>object<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">x-kubernetes-validations</span>:<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span>- <span style=\"color:#008000;font-weight:bold\">message</span>:<span style=\"color:#bbb\"> </span>Value is required once set<span style=\"color:#bbb\">\n</span></span></span><span style=\"display:flex;\"><span><span style=\"color:#bbb\"> </span><span style=\"color:#008000;font-weight:bold\">rule</span>:<span style=\"color:#bbb\"> </span><span style=\"color:#b44\">&#39;!has(oldSelf.values) || has(self.values)&#39;</span><span style=\"color:#bbb\">\n</span></span></span></code></pre></div><h1 id=\"going-further\">Going further</h1>\n<p>The above examples showed how CEL rules can be added to kubebuilder types.\nThe same rules can be added directly to OpenAPI if writing a manifest for a CRD by hand.</p>\n<p>For native types, the same behavior can be achieved using kube-openapi’s marker\n<a href=\"https://github.com/kubernetes/kube-openapi/blob/923526ac052c59656d41710b45bbcb03748aa9d6/pkg/generators/extension.go#L69\"><code>+validations</code></a>.</p>\n<p>Usage of CEL within Kubernetes Validation Rules is so much more powerful than\nwhat has been shown in this article. For more information please check out\n<a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation-rules\">validation rules</a>\nin the Kubernetes documentation and <a href=\"https://kubernetes.io/blog/2022/09/23/crd-validation-rules-beta/\">CRD Validation Rules Beta</a> blog post.</p>","PublishedAt":"2022-09-29 00:00:00+00:00","OriginURL":"https://kubernetes.io/blog/2022/09/29/enforce-immutability-using-cel/","SourceName":"Kubernetes"}},{"node":{"ID":1817,"Title":"DRUIDS, the Design System that Powers Datadog","Description":"<img class=\"webfeedsFeaturedVisual rss\" src=\"https://imgix.datadoghq.com/img/blog/engineering/druids-the-design-system-that-powers-datadog/druids-the-design-system-that-powers-datadog.png\" width=\"100%\"/>In 2018, Datadog was in the midst of rapid expansion. We had recently released APM to complement our core infrastructure monitoring product and, with the addition of Log Management and the development of Synthetic and Real User Monitoring, we were becoming a unified data platform.For an enterprise software platform to be successful, the whole has to be greater than the sum of its parts. In Datadog’s case, it means users must be able to connect different types of data, pivot seamlessly from one context to another, and follow the thread of an investigation wherever it might lead.","PublishedAt":"2022-09-29 00:00:00+00:00","OriginURL":"https://www.datadoghq.com/blog/engineering/druids-the-design-system-that-powers-datadog/","SourceName":"Datadog"}}]}},"pageContext":{"limit":30,"skip":3930,"numPages":193,"currentPage":132}},"staticQueryHashes":["3649515864"]}